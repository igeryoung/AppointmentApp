# P0-03: å®Œå…¨å¼€æ”¾çš„ CORS é…ç½®

> **ä¼˜å…ˆçº§**: ~~ğŸ”´ P0 - Critical~~ â†’ âšª N/A - Not Applicable
> **çŠ¶æ€**: âœ… å·²è§£å†³ (ç§»é™¤äº†ä¸å¿…è¦çš„ CORS ä¸­é—´ä»¶)
> **å®é™…æ—¶é—´**: 5åˆ†é’Ÿ
> **å½±å“èŒƒå›´**: æ— å½±å“ (ä»…é€‚ç”¨äº Web å®¢æˆ·ç«¯)

---

## ğŸ¯ é‡è¦è¯´æ˜ï¼šCORS ä»…å½±å“ Web æµè§ˆå™¨

**æœ¬é¡¹ç›®æ˜¯ç§»åŠ¨ç«¯åº”ç”¨ (iOS/Android)**ï¼ŒCORS ç­–ç•¥**å®Œå…¨ä¸é€‚ç”¨**ï¼š

| å®¢æˆ·ç«¯ç±»å‹ | æ˜¯å¦å— CORS é™åˆ¶ | åŸå›  |
|-----------|---------------|------|
| Web æµè§ˆå™¨ (Chrome, Safari, Firefox) | âœ… æ˜¯ | æµè§ˆå™¨å¼ºåˆ¶æ‰§è¡ŒåŒæºç­–ç•¥ |
| åŸç”Ÿç§»åŠ¨åº”ç”¨ (iOS, Android) | âŒ å¦ | ç›´æ¥å‘èµ· HTTP è¯·æ±‚ï¼Œä¸é€šè¿‡æµè§ˆå™¨ |
| æ¡Œé¢åº”ç”¨ (Electron, native) | âŒ å¦ | ä¸å—æµè§ˆå™¨å®‰å…¨é™åˆ¶ |
| API å·¥å…· (curl, Postman) | âŒ å¦ | æ— åŒæºç­–ç•¥ |

**ç»“è®º**ï¼š
- åŸå§‹çš„ `Access-Control-Allow-Origin: *` **å¯¹ç§»åŠ¨åº”ç”¨æ— å®‰å…¨å½±å“**
- ç§»åŠ¨åº”ç”¨ä¼šå¿½ç•¥æ‰€æœ‰ CORS å“åº”å¤´
- å·²ç§»é™¤ CORS ä¸­é—´ä»¶ï¼Œç®€åŒ–ä»£ç 

**å¦‚æœæœªæ¥æ·»åŠ  Web ç‰ˆæœ¬**ï¼Œéœ€è¦é‡æ–°å®ç°ç™½åå•å¼ CORS é…ç½®ï¼ˆè§ä¸‹æ–¹åŸå§‹æ–¹æ¡ˆï¼‰ã€‚

---

## ğŸ“‹ é—®é¢˜æè¿°

### å½“å‰çŠ¶æ€

**æ–‡ä»¶**: `server/main.dart:122-126`

```dart
.addMiddleware(corsHeaders(headers: {
  'Access-Control-Allow-Origin': '*',  // ğŸ”´ å…è®¸ä»»ä½•æ¥æº
  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Authorization',
}))
```

### ä¸ºä»€ä¹ˆè¿™æ˜¯é—®é¢˜

1. **ä»»ä½•ç½‘ç«™éƒ½èƒ½è°ƒç”¨ API**
   - `evil.com` å¯ä»¥å‘èµ·è¯·æ±‚åˆ°ä½ çš„æœåŠ¡å™¨
   - æµè§ˆå™¨ä¼šé™„å¸¦ç”¨æˆ·çš„ Tokenï¼ˆå¦‚æœå­˜å‚¨åœ¨ Cookie æˆ– LocalStorageï¼‰
   - æ”»å‡»è€…è·å¾—ç”¨æˆ·å®Œæ•´æƒé™

2. **CSRF æ”»å‡»**
   ```html
   <!-- æ”»å‡»è€…åœ¨ evil.com æ”¾ç½®æ­¤ä»£ç  -->
   <script>
   fetch('https://your-api.com/api/books/delete/1', {
     method: 'DELETE',
     headers: {
       'Content-Type': 'application/json',
       'Authorization': 'Bearer stolen-token'
     }
   });
   </script>
   ```

3. **æ•°æ®æ³„éœ²**
   - ç”¨æˆ·è®¿é—®æ¶æ„ç½‘ç«™
   - ç½‘ç«™é€šè¿‡ JavaScript è°ƒç”¨ä½ çš„ API
   - çªƒå–æ‰€æœ‰æ‚£è€…æ•°æ®

### çœŸå®é£é™©åœºæ™¯

```
åœºæ™¯ 1ï¼šé’“é±¼æ”»å‡»
1. åŒ»ç”Ÿæ”¶åˆ°é‚®ä»¶ï¼š"æŸ¥çœ‹æ–°çš„æ‚£è€…æŠ¥å‘Š"
2. é“¾æ¥æŒ‡å‘ evil.comï¼ˆä¼ªè£…æˆåŒ»é™¢ç½‘ç«™ï¼‰
3. evil.com åŠ è½½åï¼ŒJavaScript è°ƒç”¨çœŸå® API
4. ä½¿ç”¨åŒ»ç”Ÿçš„ Token ä¸‹è½½æ‰€æœ‰æ‚£è€…æ•°æ®
5. å‘é€åˆ°æ”»å‡»è€…æœåŠ¡å™¨

åœºæ™¯ 2ï¼šå¹¿å‘Šæ³¨å…¥
1. åŒ»ç”Ÿè®¿é—®æ–°é—»ç½‘ç«™ï¼ˆæœ‰å¹¿å‘Šï¼‰
2. å¹¿å‘Šè„šæœ¬è°ƒç”¨ä½ çš„ API
3. æ£€æµ‹æ˜¯å¦æœ‰ Schedule Note Token
4. å¦‚æœæœ‰ï¼Œçªƒå–æ•°æ®å¹¶å‡ºå”®

åœºæ™¯ 3ï¼šç¬¬ä¸‰æ–¹è„šæœ¬
1. åŒ»é™¢ç½‘ç«™é›†æˆç¬¬ä¸‰æ–¹èŠå¤©å·¥å…·
2. èŠå¤©å·¥å…·è„šæœ¬è¢«æ±¡æŸ“
3. è°ƒç”¨ Schedule Note API æ”¶é›†æ•°æ®
4. æ•°æ®è¢«å‡ºå”®ç»™ä¿é™©å…¬å¸
```

---

## ğŸ§  Linus å¼æ ¹å› åˆ†æ

### æ•°æ®ç»“æ„é—®é¢˜

**å½“å‰**ï¼šæ²¡æœ‰"æ¥æº"æ¦‚å¿µ
```
ä»»ä½•ç½‘ç«™ â”€â”€è¯·æ±‚â”€â”€> API
             â†“
           éƒ½æ¥å—
```

**åº”è¯¥**ï¼šåªæ¥å—å¯ä¿¡æ¥æº
```
ä¿¡ä»»åˆ—è¡¨ = [app.hospital.com, localhost]
           â†“
è¯·æ±‚æ¥æº âˆˆ ä¿¡ä»»åˆ—è¡¨ï¼Ÿ
   â”œâ”€ æ˜¯ï¼šå¤„ç†è¯·æ±‚
   â””â”€ å¦ï¼šæ‹’ç»è¯·æ±‚
```

### å¤æ‚åº¦åˆ†æ

**ä¸éœ€è¦å¤æ‚çš„ CORS ç³»ç»Ÿ**ï¼Œéœ€è¦çš„æ˜¯**ç™½åå•**ã€‚

**æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µ**ï¼š
- âŒ ç”Ÿäº§ç”¨é™åˆ¶ï¼Œå¼€å‘ç”¨ `*`
- âœ… æ‰€æœ‰ç¯å¢ƒéƒ½ç”¨ç™½åå•ï¼ˆå¼€å‘ç¯å¢ƒåŒ…å« `localhost`ï¼‰

**ä¸ºä»€ä¹ˆæœ‰äººç”¨ `*`ï¼Ÿ**
- "æ–¹ä¾¿è°ƒè¯•" â†’ âŒ è°ƒè¯•å®Œå°±å¿˜äº†æ”¹å›æ¥
- "ä¸çŸ¥é“å‰ç«¯åŸŸå" â†’ âŒ é‚£å°±å…ˆåˆ«ä¸Šçº¿
- "ç§»åŠ¨åº”ç”¨ä¸éœ€è¦ CORS" â†’ âš ï¸ ä½† Web ç‰ˆéœ€è¦

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šç¯å¢ƒå˜é‡åŒ–çš„åŸŸåç™½åå•

**åŸåˆ™**ï¼š
1. **é»˜è®¤æ‹’ç»æ‰€æœ‰**
2. **æ˜ç¡®åˆ—å‡ºå…è®¸çš„åŸŸå**
3. **ä¸åŒç¯å¢ƒä¸åŒç™½åå•**

### ä¿®æ”¹ä»£ç 

**æ–‡ä»¶**: `server/lib/config/database_config.dart`ï¼ˆæ–°å¢ CORS é…ç½®ï¼‰

```dart
class ServerConfig {
  final String host;
  final int port;
  final bool isDevelopment;
  final List<String> allowedOrigins;  // ğŸ†• å…è®¸çš„åŸŸååˆ—è¡¨

  const ServerConfig({
    required this.host,
    required this.port,
    this.isDevelopment = true,
    required this.allowedOrigins,
  });

  factory ServerConfig.development() {
    return ServerConfig(
      host: '0.0.0.0',
      port: 8080,
      isDevelopment: true,
      allowedOrigins: [
        'http://localhost:*',  // æœ¬åœ°å¼€å‘ï¼Œä»»ä½•ç«¯å£
        'https://localhost:*',
      ],
    );
  }

  factory ServerConfig.production() {
    // ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œé€—å·åˆ†éš”
    final originsStr = Platform.environment['ALLOWED_ORIGINS'];
    if (originsStr == null || originsStr.isEmpty) {
      throw Exception('ALLOWED_ORIGINS environment variable must be set for production');
    }

    return ServerConfig(
      host: Platform.environment['SERVER_HOST'] ?? '0.0.0.0',
      port: int.parse(Platform.environment['SERVER_PORT'] ?? '443'),
      isDevelopment: false,
      allowedOrigins: originsStr.split(',').map((s) => s.trim()).toList(),
    );
  }
}
```

**æ–‡ä»¶**: `server/main.dart`

```dart
// ğŸ†• åŠ¨æ€ CORS ä¸­é—´ä»¶
Middleware _corsMiddleware(ServerConfig config) {
  return (Handler handler) {
    return (Request request) async {
      final origin = request.headers['origin'];

      // æ£€æŸ¥æ¥æºæ˜¯å¦åœ¨ç™½åå•ä¸­
      final isAllowed = origin != null && _isOriginAllowed(origin, config.allowedOrigins);

      // å¤„ç† OPTIONS é¢„æ£€è¯·æ±‚
      if (request.method == 'OPTIONS') {
        if (isAllowed) {
          return Response.ok('', headers: {
            'Access-Control-Allow-Origin': origin,
            'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
            'Access-Control-Allow-Headers': 'Content-Type, Authorization',
            'Access-Control-Max-Age': '86400',  // ç¼“å­˜24å°æ—¶
          });
        } else {
          return Response.forbidden('Origin not allowed');
        }
      }

      // å¤„ç†å®é™…è¯·æ±‚
      final response = await handler(request);

      // å¦‚æœæ¥æºå…è®¸ï¼Œæ·»åŠ  CORS å¤´
      if (isAllowed) {
        return response.change(headers: {
          'Access-Control-Allow-Origin': origin,
          'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type, Authorization',
        });
      }

      return response;
    };
  };
}

// ğŸ†• æ£€æŸ¥æ¥æºæ˜¯å¦åœ¨ç™½åå•ä¸­
bool _isOriginAllowed(String origin, List<String> allowedOrigins) {
  for (final allowed in allowedOrigins) {
    if (_matchOrigin(origin, allowed)) {
      return true;
    }
  }
  return false;
}

// ğŸ†• åŒ¹é…æ¥æºï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
bool _matchOrigin(String origin, String pattern) {
  // ç²¾ç¡®åŒ¹é…
  if (origin == pattern) return true;

  // é€šé…ç¬¦åŒ¹é…ï¼ˆä»…æ”¯æŒç«¯å£éƒ¨åˆ†ï¼‰
  if (pattern.endsWith(':*')) {
    final basePattern = pattern.substring(0, pattern.length - 2);
    return origin.startsWith(basePattern);
  }

  return false;
}

void main(List<String> args) async {
  // ... ç°æœ‰ä»£ç  ...

  // ğŸ”´ æ›¿æ¢æ—§çš„ corsHeaders ä¸­é—´ä»¶
  final handler = Pipeline()
      .addMiddleware(logRequests())
      .addMiddleware(_errorHandler())
      .addMiddleware(_corsMiddleware(serverConfig))  // ğŸ†• ä½¿ç”¨æ–°çš„ CORS ä¸­é—´ä»¶
      .addHandler(app);

  // ... ç°æœ‰ä»£ç  ...
}
```

### ç¯å¢ƒé…ç½®

**æ–‡ä»¶**: `.env.example`

```bash
# CORS Configuration
# é€—å·åˆ†éš”çš„å…è®¸åŸŸååˆ—è¡¨
# ç”Ÿäº§ç¯å¢ƒç¤ºä¾‹
ALLOWED_ORIGINS=https://app.hospital.com,https://admin.hospital.com

# å¼€å‘ç¯å¢ƒï¼ˆè‡ªåŠ¨åŒ…å« localhostï¼‰
# ALLOWED_ORIGINS=http://localhost:3000,https://localhost:3000
```

**æ–‡ä»¶**: `server/README.md`ï¼ˆæ–°å¢ï¼‰

```markdown
## CORS é…ç½®

### å…è®¸çš„æ¥æº

é€šè¿‡ `ALLOWED_ORIGINS` ç¯å¢ƒå˜é‡è®¾ç½®å…è®¸çš„åŸŸåï¼Œå¤šä¸ªåŸŸåç”¨é€—å·åˆ†éš”ï¼š

```bash
export ALLOWED_ORIGINS="https://app.hospital.com,https://admin.hospital.com"
```

### å¼€å‘ç¯å¢ƒ

å¼€å‘æ¨¡å¼è‡ªåŠ¨å…è®¸æ‰€æœ‰ `localhost` ç«¯å£ï¼š
- `http://localhost:*`
- `https://localhost:*`

### æ·»åŠ æ–°åŸŸå

1. æ›´æ–°ç¯å¢ƒå˜é‡ï¼š
   ```bash
   export ALLOWED_ORIGINS="$ALLOWED_ORIGINS,https://new-domain.com"
   ```

2. é‡å¯æœåŠ¡å™¨

3. æµ‹è¯•æ–°åŸŸåæ˜¯å¦å¯ä»¥è®¿é—® API

### å®‰å…¨æç¤º

âš ï¸ **æ°¸è¿œä¸è¦ä½¿ç”¨ `*`**ï¼š
- âŒ `ALLOWED_ORIGINS=*`
- âœ… `ALLOWED_ORIGINS=https://specific-domain.com`
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### æµ‹è¯• 1ï¼šæ‹’ç»æœªæˆæƒæ¥æº

```bash
# ä»æœªæˆæƒåŸŸåå‘èµ·è¯·æ±‚
curl -H "Origin: https://evil.com" \
     https://your-api.com/api/devices/register \
     -v

# é¢„æœŸç»“æœï¼š
# âŒ å“åº”ä¸­æ—  Access-Control-Allow-Origin å¤´
# æˆ–è¿”å› 403 Forbidden
```

### æµ‹è¯• 2ï¼šæ¥å—ç™½åå•æ¥æº

```bash
# ä»ç™½åå•åŸŸåå‘èµ·è¯·æ±‚
curl -H "Origin: https://app.hospital.com" \
     https://your-api.com/health \
     -v

# é¢„æœŸç»“æœï¼š
# âœ… Access-Control-Allow-Origin: https://app.hospital.com
# âœ… æ­£å¸¸å“åº”
```

### æµ‹è¯• 3ï¼šå¼€å‘ç¯å¢ƒå…è®¸ localhost

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
dart run main.dart --dev

# ä» localhost å‘èµ·è¯·æ±‚
curl -H "Origin: http://localhost:3000" \
     http://localhost:8080/health \
     -v

# é¢„æœŸç»“æœï¼š
# âœ… Access-Control-Allow-Origin: http://localhost:3000
```

### æµ‹è¯• 4ï¼šOPTIONS é¢„æ£€è¯·æ±‚

```bash
# å‘é€é¢„æ£€è¯·æ±‚
curl -X OPTIONS \
     -H "Origin: https://app.hospital.com" \
     -H "Access-Control-Request-Method: POST" \
     https://your-api.com/api/sync/pull

# é¢„æœŸç»“æœï¼š
# âœ… 200 OK
# âœ… Access-Control-Allow-Origin: https://app.hospital.com
# âœ… Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
```

---

## ğŸ“¦ å‘åå…¼å®¹æ€§

### ç°æœ‰ Web å®¢æˆ·ç«¯

**é—®é¢˜**ï¼šå¦‚æœæœ‰ Web ç‰ˆå®¢æˆ·ç«¯ï¼Œå¯èƒ½ä¼šè¢«é˜»æ­¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **ç¡®è®¤ Web å®¢æˆ·ç«¯çš„åŸŸå**
   ```bash
   # ç”Ÿäº§ç¯å¢ƒ
   https://app.hospital.com
   # æµ‹è¯•ç¯å¢ƒ
   https://test-app.hospital.com
   ```

2. **æ·»åŠ åˆ°ç™½åå•**
   ```bash
   export ALLOWED_ORIGINS="https://app.hospital.com,https://test-app.hospital.com"
   ```

3. **é€šçŸ¥ç”¨æˆ·**
   - å¦‚æœç”¨æˆ·è‡ªè¡Œéƒ¨ç½²äº† Web ç‰ˆï¼Œéœ€è¦å‘ŠçŸ¥æ›´æ–°ç¯å¢ƒå˜é‡

### ç§»åŠ¨åº”ç”¨

**ä¸å—å½±å“**ï¼š
- ç§»åŠ¨åº”ç”¨ä¸é€šè¿‡æµè§ˆå™¨å‘èµ·è¯·æ±‚
- ä¸å— CORS ç­–ç•¥é™åˆ¶
- æ— éœ€ä»»ä½•ä¿®æ”¹

---

## âœ… éªŒæ”¶æ ‡å‡†

- [ ] æœªæˆæƒæ¥æºè¢«æ‹’ç»
- [ ] ç™½åå•æ¥æºè¢«æ¥å—
- [ ] OPTIONS é¢„æ£€è¯·æ±‚æ­£å¸¸
- [ ] å¼€å‘ç¯å¢ƒå…è®¸ localhost
- [ ] ç”Ÿäº§ç¯å¢ƒæ—  `ALLOWED_ORIGINS` æ—¶æ‹’ç»å¯åŠ¨
- [ ] README æ–‡æ¡£å·²æ›´æ–°

---

## ğŸ“ ä¿®å¤æ£€æŸ¥æ¸…å•

### ä¿®æ”¹å‰
- [ ] ç¡®è®¤æ‰€æœ‰éœ€è¦è®¿é—® API çš„åŸŸå
- [ ] è®°å½•å½“å‰ CORS é…ç½®
- [ ] å‡†å¤‡æµ‹è¯•ç¯å¢ƒ

### ä¿®æ”¹ä»£ç 
- [ ] æ·»åŠ  `allowedOrigins` åˆ° `ServerConfig`
- [ ] å®ç° `_corsMiddleware()`
- [ ] å®ç° `_isOriginAllowed()`
- [ ] å®ç° `_matchOrigin()`
- [ ] æ›¿æ¢æ—§çš„ `corsHeaders` ä¸­é—´ä»¶

### æµ‹è¯•éªŒè¯
- [ ] æœªæˆæƒæ¥æºè¢«æ‹’ç»
- [ ] ç™½åå•æ¥æºè¢«æ¥å—
- [ ] OPTIONS é¢„æ£€è¯·æ±‚æ­£å¸¸
- [ ] å¼€å‘ç¯å¢ƒ localhost å¯ç”¨

### éƒ¨ç½²
- [ ] è®¾ç½® `ALLOWED_ORIGINS` ç¯å¢ƒå˜é‡
- [ ] é‡å¯æœåŠ¡å™¨
- [ ] éªŒè¯æ‰€æœ‰å®¢æˆ·ç«¯è¿æ¥æ­£å¸¸
- [ ] ç›‘æ§æ—¥å¿—ç¡®è®¤æ— æ„å¤–æ‹’ç»

---

## ğŸ”— ç›¸å…³é—®é¢˜

- [P0-02: HTTPS å¼ºåˆ¶æ‰§è¡Œ](02_https_enforcement.md) - ä¼ è¾“å®‰å…¨
- [P2-09: è¾“å…¥éªŒè¯](../P2_MEDIUM/09_input_validation.md) - è¯·æ±‚éªŒè¯
- [å®‰å…¨æœ€ä½³å®è·µ](../SECURITY_BEST_PRACTICES.md) - CORS é…ç½®æŒ‡å—

---

## ğŸ“Š çŠ¶æ€è¿½è¸ª

| é˜¶æ®µ | çŠ¶æ€ | å®Œæˆæ—¶é—´ | è´Ÿè´£äºº |
|------|------|----------|--------|
| é—®é¢˜ç¡®è®¤ | âœ… | 2025-10-20 | Linus |
| æ–¹æ¡ˆè®¾è®¡ | âœ… | 2025-10-20 | Linus |
| ç¡®è®¤å®¢æˆ·ç«¯ç±»å‹ | âœ… | 2025-10-21 | ç”¨æˆ· |
| ä»£ç ä¿®æ”¹ | âœ… | 2025-10-21 | Claude (Linus æ¨¡å¼) |
| æµ‹è¯•éªŒè¯ | â¸ï¸ | å¾…æµ‹è¯• | - |
| éƒ¨ç½²ä¸Šçº¿ | N/A | - | ç§»åŠ¨åº”ç”¨æ— éœ€éƒ¨ç½² |

---

**Linus è¯´**ï¼š

åŸè¯ï¼š`Access-Control-Allow-Origin: *` å°±åƒåœ¨é—¨å£æŒ‚ç‰Œå­è¯´"æ¬¢è¿æ‰€æœ‰å°å·"ã€‚

**ä½†å¯¹äºç§»åŠ¨åº”ç”¨**ï¼š"CORS æ˜¯æµè§ˆå™¨çš„äº‹ï¼Œç§»åŠ¨åº”ç”¨ä¸éœ€è¦è¿™ç©æ„å„¿ã€‚åˆ æ‰ä¸ç”¨çš„ä»£ç ã€‚"

âœ… **å·²ç§»é™¤ä¸å¿…è¦çš„ CORS ä¸­é—´ä»¶** - ä»£ç æ›´ç®€æ´ï¼Œæ— å®‰å…¨å½±å“ã€‚
