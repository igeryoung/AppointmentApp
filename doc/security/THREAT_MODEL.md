# Schedule Note App - 威胁建模

> **作者**: Linus Torvalds
> **日期**: 2025-10-20
> **方法**: STRIDE 威胁建模

---

## 🎯 系统概览

```
┌─────────────┐                    ┌──────────────┐
│   Mobile    │ ──── HTTPS ───────>│    Server    │
│   Client    │                    │  (Dart/Shelf)│
│  (Flutter)  │ <──── JSON ────────│              │
└─────────────┘                    └──────────────┘
      │                                    │
      │ SQLite                             │ PostgreSQL
      ▼                                    ▼
┌─────────────┐                    ┌──────────────┐
│   Local     │                    │   Central    │
│  Database   │                    │   Database   │
└─────────────┘                    └──────────────┘

数据流：
1. 用户创建预约 → 本地 SQLite
2. 同步触发 → 上传到 PostgreSQL
3. 其他设备下载 → 本地 SQLite
```

---

## 🚨 资产分类

| 资产 | 价值 | 保护需求 |
|------|------|----------|
| **患者医疗数据** | 极高 | 机密性、完整性、可用性 |
| **Device Token** | 高 | 机密性 |
| **数据库凭证** | 极高 | 机密性 |
| **服务可用性** | 中 | 可用性 |
| **审计日志** | 中 | 完整性 |

---

## 🔍 STRIDE 威胁分析

### S - Spoofing（身份假冒）

#### 威胁 S-1：伪造设备身份
- **描述**: 攻击者窃取 Device Token，假冒合法设备
- **影响**: 访问所有患者数据
- **可能性**: 高（Token 永不过期）
- **缓解**: P1-05 Token 过期机制

#### 威胁 S-2：中间人攻击
- **描述**: 公共 Wi-Fi 上截获通信，窃取 Token
- **影响**: 完全控制用户账户
- **可能性**: 中（如果无 HTTPS）
- **缓解**: P0-02 强制 HTTPS

---

### T - Tampering（数据篡改）

#### 威胁 T-1：篡改医疗记录
- **描述**: 攻击者修改患者预约时间、诊断笔记
- **影响**: 错误的医疗决策，法律责任
- **可能性**: 中（如果获得访问权限）
- **缓解**: 审计日志、数字签名（未实现）

#### 威胁 T-2：SQL 注入篡改
- **描述**: 通过 SQL 注入修改或删除数据
- **影响**: 数据完整性破坏
- **可能性**: 高（当前存在漏洞）
- **缓解**: P0-04 SQL 注入防护

---

### R - Repudiation（否认性）

#### 威胁 R-1：无法追溯操作
- **描述**: 员工删除记录后否认操作
- **影响**: 法律纠纷时无证据
- **可能性**: 低（有基本日志）
- **缓解**: 完善审计日志（P3）

---

### I - Information Disclosure（信息泄露）

#### 威胁 I-1：数据库文件泄露
- **描述**: 手机或服务器硬盘被盗，数据库未加密
- **影响**: 所有患者信息暴露
- **可能性**: 中
- **缓解**: P1-06 数据加密

#### 威胁 I-2：网络嗅探
- **描述**: HTTP 明文传输被监听
- **影响**: 实时数据泄露
- **可能性**: 高（公共网络）
- **缓解**: P0-02 强制 HTTPS

#### 威胁 I-3：跨站数据窃取
- **描述**: 恶意网站通过 CORS 调用 API
- **影响**: 批量窃取患者数据
- **可能性**: 高（当前 CORS 开放）
- **缓解**: P0-03 CORS 白名单

#### 威胁 I-4：错误消息泄露
- **描述**: 详细错误消息暴露内部结构
- **影响**: 帮助攻击者了解系统
- **可能性**: 中
- **缓解**: 统一错误处理（未实现）

---

### D - Denial of Service（拒绝服务）

#### 威胁 D-1：API 洪水攻击
- **描述**: 大量请求耗尽服务器资源
- **影响**: 服务不可用，影响医生工作
- **可能性**: 高（无速率限制）
- **缓解**: P1-07 速率限制

#### 威胁 D-2：数据库连接耗尽
- **描述**: 恶意同步请求占满数据库连接池
- **影响**: 所有用户无法访问
- **可能性**: 中
- **缓解**: 连接池限制 + 速率限制

#### 威胁 D-3：大文件上传攻击
- **描述**: 上传巨大的 Backup 文件
- **影响**: 存储空间耗尽
- **可能性**: 低
- **缓解**: 文件大小限制（未实现）

---

### E - Elevation of Privilege（权限提升）

#### 威胁 E-1：访问其他设备数据
- **描述**: 修改 deviceId 参数访问其他设备的数据
- **影响**: 跨设备数据泄露
- **可能性**: 中
- **缓解**: 严格的设备所有权检查（P2-12）

#### 威胁 E-2：管理员权限滥用
- **描述**: 数据库管理员访问所有患者数据
- **影响**: 内部人员泄露
- **可能性**: 低（信任模型）
- **缓解**: 审计 + 数据加密（P1-06）

---

## 🎯 攻击场景

### 场景 1：公共 Wi-Fi 攻击

```
1. 医生在咖啡店连接公共 Wi-Fi
2. 攻击者运行 Wireshark 抓包
3. [如果无 HTTPS] 捕获 Device Token
4. 攻击者使用 Token 访问 API
5. 下载所有患者数据
6. 在暗网出售
```

**防御层**：
- ✅ P0-02: 强制 HTTPS（阻止抓包）
- ✅ P1-05: Token 过期（限制时间窗口）
- ✅ P1-07: 速率限制（检测异常行为）

---

### 场景 2：内部人员攻击

```
1. 离职员工仍知道数据库密码
2. 从家中连接到生产数据库
3. 导出整个数据库
4. 联系竞争对手出售数据
```

**防御层**：
- ✅ P0-01: 环境变量密码（定期轮换）
- ✅ P1-06: 数据加密（即使导出也不可读）
- ⚠️  审计日志（检测异常访问，P3）

---

### 场景 3：供应链攻击

```
1. Flutter 依赖包被污染
2. 恶意代码读取 SQLite 数据库
3. 上传到攻击者服务器
4. 批量泄露患者数据
```

**防御层**：
- ✅ P1-06: SQLite 加密（无法直接读取）
- ⚠️  依赖安全扫描（未实现）
- ⚠️  代码签名验证（未实现）

---

### 场景 4：SQL 注入攻击

```
1. 攻击者分析 API 请求
2. 发现 tableName 参数
3. 注入: "books; DROP TABLE devices--"
4. 删除所有设备认证信息
5. 系统瘫痪
```

**防御层**：
- ✅ P0-04: 表名白名单（阻止注入）
- ✅ P2-09: 输入验证（纵深防御）

---

## 📊 风险矩阵

```
影响 ↑
高 │ I-1,I-2,I-3  │ S-1,T-2,D-1  │
   │ [P1-06]      │ [P0-04,P1-07]│
中 │ D-2,E-1      │ T-1,I-4      │
   │ [P2-12]      │ [P3]         │
低 │ D-3          │ R-1          │
   │ [P3]         │ [P3]         │
   └──────────────┴──────────────┴──> 可能性
      低            中            高
```

---

## ✅ 优先级修复顺序

1. **P0（立即）**: I-2, I-3, T-2 → 修复 P0-01~04
2. **P1（7天）**: S-1, D-1, I-1 → 修复 P1-05~08
3. **P2（30天）**: E-1, T-1, D-2 → 修复 P2-09~12
4. **P3（长期）**: R-1, I-4, D-3 → 改进阶段

---

## 🔄 持续威胁建模

每次重大功能更新时，重新评估：

1. **新增数据流？** → 检查 I（信息泄露）
2. **新增 API？** → 检查 S（身份假冒）、D（拒绝服务）
3. **新增权限？** → 检查 E（权限提升）
4. **数据结构变化？** → 检查 T（数据篡改）

---

**Linus 说**：威胁建模不是一次性任务。每次加新功能，问自己："这会引入什么新漏洞？"
